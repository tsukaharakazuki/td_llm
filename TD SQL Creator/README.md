# TD SQL Creator

トレジャーデータ（Treasure Data）向けの専門的なSQL作成支援AIエージェントです。データ分析要件をもとに、最適化されたSQL文を自動生成し、包括的な分析プロセスを提供します。

## 概要

TD SQL Creatorは、トレジャーデータプラットフォーム上でのSQL開発を効率化するLLMエージェントです。TrinoSQL（デフォルト）およびHive SQLに対応し、テーブル探索からデータ分析、SQL最適化まで一貫したワークフローを提供します。

## 主要機能

### 🔍 データベース探索
- **テーブル一覧取得**: 指定データベース内の全テーブルを効率的にリスト化
- **カラム情報分析**: 必要なテーブルのみを対象とした詳細なスキーマ情報取得
- **サンプルデータ確認**: 実際のデータ内容とデータ品質の検証

### 📊 SQL作成・最適化
- **Trino SQL対応**: トレジャーデータ標準のTrino SQLエンジン向け最適化
- **Hive SQL対応**: レガシーシステム連携用のHive SQL生成
- **UDF活用**: トレジャーデータ専用のユーザー定義関数を活用した効率的なクエリ作成
- **パフォーマンス最適化**: 大量データ処理を考慮したクエリ設計

### 🛠️ 分析プロセス
- **段階的検証**: データ品質、NULL率、カラム網羅性の自動検証
- **エラーハンドリング**: SQL実行エラーの自動検出・修正
- **可視化対応**: Plotly.jsを使用したチャート生成機能

## プロジェクト構成

```
TD SQL Creator/
├── README.md                          # プロジェクト概要（このファイル）
├── agents/
│   └── [Main] TD SQL Creator.md      # メインエージェント設定
└── knowledgebase/
    ├── trino_sql_udf.md              # Trino SQL UDF参考資料
    └── hive_sql_udf.md               # Hive SQL UDF参考資料
```

## 使用方法

### 1. 初期設定
エージェントを起動後、以下を指定してください：
- 使用するデータベース名
- SQL方言（Trino SQL / Hive SQL）

### 2. 基本ワークフロー

1. **データベース選択**
   ```
   どのデータベースを使用しますか？
   ```

2. **テーブル探索**
   - 利用可能なテーブル一覧の自動取得
   - 各テーブルの目的・概要の表示

3. **テーブル選択**
   - 分析対象テーブルの明示的な選択
   - 複数テーブルの並列処理対応

4. **SQL生成**
   - 要件に基づく最適化されたSQL作成
   - 実行エラーの自動チェック・修正

5. **結果出力**
   - 構造化されたSQL文
   - 日本語での詳細な処理説明

### 3. 出力例

**SQL文**
```sql
SELECT
    user_id,
    COUNT(*) as action_count,
    AVG(session_duration) as avg_duration
FROM
    analytics.user_sessions
WHERE
    TD_TIME_RANGE(time, '2024-01-01', '2024-01-31', 'JST')
    AND user_id IS NOT NULL
GROUP BY
    user_id
ORDER BY
    action_count DESC
LIMIT 100;

-- ユーザー別のセッション集計
-- 2024年1月のデータを対象に、セッション数と平均時間を算出
```

**SQL説明**
このクエリは、2024年1月のユーザーセッションデータを分析し、ユーザー別のアクティビティ指標を算出しています。TD_TIME_RANGE関数を使用して効率的な時間フィルタリングを行い、NULL値を除外した上で集計処理を実行しています。

## 技術仕様

### エージェント設定
- **モデル**: Claude 4.0 Sonnet
- **最大ツール実行回数**: 20回
- **温度設定**: 0.0（決定論的出力）

### 対応ツール
- `list_tables_{database_name}`: テーブル一覧取得
- `list_columns_{database_name}`: カラム情報取得
- `search_tables`: サンプルデータ取得
- `null_rate`: NULL率分析
- `trino_sql_udf`: Trino SQL UDF参照
- `hive_sql_udf`: Hive SQL UDF参照

### 出力機能
- **Plotly.js連携**: インタラクティブなグラフ・チャート生成
- **構造化レポート**: マークダウン形式での詳細分析結果

## ベストプラクティス

### SQL作成時の注意点
- カラム名は小文字で統一
- WITH句・サブクエリでの可読性確保
- TD_TIME_RANGE等のTreasure Data専用関数の積極活用
- 大量データ処理時のパフォーマンス考慮

### セキュリティ・プライバシー
- 機密情報・個人情報の適切な取り扱い
- データアクセス権限の事前確認
- クエリ実行前の影響範囲検証

## ライセンス・サポート

このプロジェクトは、トレジャーデータプラットフォーム上でのSQL開発効率化を目的として開発されています。
使用時は、各組織のデータガバナンス方針に従って適切にご利用ください。

---

**開発・メンテナンス**: LLMエージェントベースの自動化ツール
**最終更新**: 2025年1月
**対象プラットフォーム**: Treasure Data（Trino SQL / Hive SQL）